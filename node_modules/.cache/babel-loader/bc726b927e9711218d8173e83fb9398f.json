{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\Kao\\\\Desktop\\\\GI472(\\u0E2A.)\\\\Visual Studio Code\\\\pwa-course-2022\\\\pwa-course-2022\\\\src\\\\context\\\\FirebaseChatContextProvider.js\",\n    _s = $RefreshSig$(),\n    _s2 = $RefreshSig$();\n\nimport React, { createContext, useContext, useState, useEffect } from \"react\";\nimport 'firebase/compat/auth';\nimport 'firebase/compat/database';\nimport { firebase } from './FirebaseConfig';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nconst hashCode = s => s.split('').reduce((a, b) => (a << 5) - a + b.charCodeAt(0) | 0, 0);\n\nconst ChatStateContext = /*#__PURE__*/createContext({\n  userList: [],\n  chatroomList: []\n});\nexport default function ChatStateProvider(_ref) {\n  _s();\n\n  let {\n    children,\n    self\n  } = _ref;\n  const usersRef = firebase.database().ref('users');\n  const chatroomsRef = firebase.database().ref('chatrooms');\n  const [userList, setUserList] = useState([]);\n  const [chatroomList, setChatroomList] = useState([]);\n\n  const chat = msg => ({\n    msg: msg,\n    user: self.uid,\n    timestamp: firebase.database.ServerValue.TIMESTAMP\n  });\n\n  useEffect(() => {\n    usersRef.on('child_added', snapshot => {\n      const excludeSelf = x => x.key !== self.uid;\n\n      setUserList(oldList => [...oldList.filter(excludeSelf), { ...snapshot.val(),\n        key: snapshot.key\n      }]);\n    });\n    usersRef.on('child_removed', snapshot => {\n      const userId = snapshot.key;\n\n      const excludeSelf = x => x.key !== userId;\n\n      setUserList(oldList => oldList.filter(excludeSelf));\n    });\n    console.log(\"self checkin to firebase\", self);\n    const x = usersRef.child(self.uid);\n    x.set({\n      displayName: self.displayName\n    });\n    x.onDisconnect().remove();\n    return () => {\n      usersRef.off('child_added');\n      usersRef.off('child_removed');\n    }; // eslint-disable-next-line\n  }, []);\n\n  const getUserProfile = uid => {\n    return usersRef.child(uid).once('value').then(snapshot => {\n      return snapshot.val();\n    });\n  };\n\n  const getPrivateChat = friendId => {\n    const chatroomId = `1-1-${hashCode(self.uid) + hashCode(friendId)}`;\n    return chatroomsRef.child(`${chatroomId}`).once('value').then(snapshot => {\n      return snapshot.val();\n    });\n  };\n\n  const listenToPrivateChat = (friendId, callback) => {\n    const chatroomId = `1-1-${hashCode(self.uid) + hashCode(friendId)}`;\n    return chatroomsRef.child(`${chatroomId}/chat`).on('child_added', snapshot => {\n      // {roomTitle, users, chat}\n      snapshot && callback(snapshot.val());\n    });\n  };\n\n  const sendPrivateMsg = (msg, friendId) => {\n    const chatroomId = `1-1-${hashCode(self.uid) + hashCode(friendId)}`;\n    const chatroomRef = chatroomsRef.child(`${chatroomId}/chat`);\n    chatroomRef.push(chat(msg));\n  };\n\n  const getChatroom = roomId => {\n    return chatroomsRef.child(`${roomId}`).once('value').then(snapshot => {\n      // {roomTitle, users, chat}\n      return snapshot.val();\n    });\n  };\n\n  const listenToChatroom = (roomId, callback) => {\n    console.log(\"self checkin to roomId\", roomId);\n    const x = chatroomsRef.child(`${roomId}/users/${self.uid}`);\n    x.set({\n      displayName: self.displayName\n    });\n    x.onDisconnect().remove();\n    return chatroomsRef.child(`${roomId}/chat`).on('child_added', snapshot => {\n      // {roomTitle, users, chat}\n      snapshot && callback(snapshot.val());\n    });\n  };\n\n  const listenToUserInChatroom = (roomId, callback) => {\n    const x = chatroomsRef.child(`${roomId}/users`);\n    x.on('child_added', snapshot => {\n      snapshot && callback('JOINED', snapshot.key, snapshot.val());\n    });\n    x.on('child_removed', snapshot => {\n      snapshot && callback('LEFT', snapshot.key, snapshot.val());\n    });\n    return () => {\n      x.off('child_added');\n      x.off('child_removed');\n    };\n  };\n\n  const sendMsg = (msg, targetId) => {\n    const chatroomRef = chatroomsRef.child(`${targetId}/chat`);\n    chatroomRef.push(chat(msg));\n  };\n\n  return /*#__PURE__*/_jsxDEV(ChatStateContext.Provider, {\n    value: {\n      userList: userList,\n      chatroomList: chatroomList,\n      getUserProfile: getUserProfile,\n      getPrivateChat: getPrivateChat,\n      listenToPrivateChat: listenToPrivateChat,\n      sendPrivateMsg: sendPrivateMsg,\n      getChatroom: getChatroom,\n      listenToChatroom: listenToChatroom,\n      listenToUserInChatroom: listenToUserInChatroom,\n      sendMsg: sendMsg\n    },\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 122,\n    columnNumber: 5\n  }, this);\n}\n\n_s(ChatStateProvider, \"/jWoRxoGylbxvAo5cbbysId2aOs=\");\n\n_c = ChatStateProvider;\nexport const useChatStateContext = () => {\n  _s2();\n\n  return useContext(ChatStateContext);\n};\n\n_s2(useChatStateContext, \"gDsCjeeItUuvgOWf1v4qoK9RF6k=\");\n\nvar _c;\n\n$RefreshReg$(_c, \"ChatStateProvider\");","map":{"version":3,"sources":["C:/Users/Kao/Desktop/GI472(à¸ª.)/Visual Studio Code/pwa-course-2022/pwa-course-2022/src/context/FirebaseChatContextProvider.js"],"names":["React","createContext","useContext","useState","useEffect","firebase","hashCode","s","split","reduce","a","b","charCodeAt","ChatStateContext","userList","chatroomList","ChatStateProvider","children","self","usersRef","database","ref","chatroomsRef","setUserList","setChatroomList","chat","msg","user","uid","timestamp","ServerValue","TIMESTAMP","on","snapshot","excludeSelf","x","key","oldList","filter","val","userId","console","log","child","set","displayName","onDisconnect","remove","off","getUserProfile","once","then","getPrivateChat","friendId","chatroomId","listenToPrivateChat","callback","sendPrivateMsg","chatroomRef","push","getChatroom","roomId","listenToChatroom","listenToUserInChatroom","sendMsg","targetId","useChatStateContext"],"mappings":"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","sourcesContent":["import React, { createContext, useContext, useState, useEffect } from \"react\";\r\nimport 'firebase/compat/auth';\r\nimport 'firebase/compat/database';\r\nimport {firebase} from './FirebaseConfig';\r\n\r\nconst hashCode = s => s.split('').reduce((a,b) => (((a << 5) - a) + b.charCodeAt(0))|0, 0)\r\n\r\nconst ChatStateContext = createContext({\r\n  userList: [],\r\n  chatroomList: []\r\n});\r\n\r\nexport default function ChatStateProvider({ children, self }) {\r\n  const usersRef = firebase.database().ref('users');\r\n  const chatroomsRef = firebase.database().ref('chatrooms');\r\n\r\n  const [userList, setUserList] = useState([]);\r\n  const [chatroomList, setChatroomList] = useState([]);\r\n\r\n  const chat = msg => ({ msg: msg, user: self.uid, timestamp: firebase.database.ServerValue.TIMESTAMP });\r\n  \r\n  useEffect(() => {\r\n    usersRef.on('child_added', snapshot => {\r\n      \r\n      const excludeSelf = x=> x.key !== self.uid;\r\n      setUserList(oldList => [...oldList.filter(excludeSelf), {\r\n        ...snapshot.val(),\r\n        key: snapshot.key\r\n      }]\r\n      );\r\n    });\r\n\r\n    usersRef.on('child_removed', snapshot => {\r\n      const userId = snapshot.key;\r\n      \r\n      const excludeSelf = x=> x.key !== userId;\r\n      setUserList(oldList => oldList.filter(excludeSelf));\r\n    });\r\n\r\n    console.log(\"self checkin to firebase\", self);\r\n    const x = usersRef.child(self.uid)\r\n    x.set({\r\n      displayName: self.displayName,\r\n    })\r\n    x.onDisconnect().remove();\r\n\r\n    return () => {\r\n      usersRef.off('child_added');\r\n      usersRef.off('child_removed');\r\n    }\r\n    // eslint-disable-next-line\r\n  }, []);\r\n\r\n  const getUserProfile = uid => {\r\n    return usersRef.child(uid).once('value').then(snapshot => {\r\n      return snapshot.val();\r\n    });\r\n  };\r\n\r\n  const getPrivateChat = (friendId) => {\r\n    const chatroomId = `1-1-${hashCode(self.uid) + hashCode(friendId)}`;\r\n    return chatroomsRef.child(`${chatroomId}`).once('value').then(snapshot => {\r\n      return snapshot.val();\r\n    });\r\n  };\r\n\r\n  const listenToPrivateChat = (friendId, callback) => {\r\n    const chatroomId = `1-1-${hashCode(self.uid) + hashCode(friendId)}`;\r\n    return chatroomsRef.child(`${chatroomId}/chat`).on('child_added', snapshot => {\r\n      // {roomTitle, users, chat}\r\n      snapshot && callback(snapshot.val());\r\n    });\r\n  };\r\n\r\n  const sendPrivateMsg = (msg, friendId) => {\r\n    const chatroomId = `1-1-${hashCode(self.uid) + hashCode(friendId)}`;\r\n    const chatroomRef = chatroomsRef.child(`${chatroomId}/chat`);\r\n    chatroomRef.push(chat(msg));\r\n  };\r\n\r\n  const getChatroom = (roomId) => {\r\n    return chatroomsRef.child(`${roomId}`).once('value').then(snapshot => {\r\n      // {roomTitle, users, chat}\r\n      return snapshot.val();\r\n    });\r\n  };\r\n\r\n  const listenToChatroom = (roomId, callback) => {\r\n    console.log(\"self checkin to roomId\", roomId);\r\n    const x = chatroomsRef.child(`${roomId}/users/${self.uid}`);\r\n    x.set({\r\n      displayName: self.displayName,\r\n    })\r\n    x.onDisconnect().remove();\r\n\r\n    return chatroomsRef.child(`${roomId}/chat`).on('child_added', snapshot => {\r\n      // {roomTitle, users, chat}\r\n      snapshot && callback(snapshot.val());\r\n    });\r\n  };\r\n\r\n  const listenToUserInChatroom = (roomId, callback) => {\r\n    const x= chatroomsRef.child(`${roomId}/users`)\r\n    x.on('child_added', snapshot => {\r\n      snapshot && callback('JOINED',snapshot.key, snapshot.val());\r\n    });\r\n    x.on('child_removed', snapshot => {\r\n      snapshot && callback('LEFT', snapshot.key, snapshot.val());\r\n    });\r\n    return () => {\r\n      x.off('child_added');\r\n      x.off('child_removed');\r\n    }\r\n  };\r\n\r\n  const sendMsg = (msg, targetId) => {\r\n    const chatroomRef = chatroomsRef.child(`${targetId}/chat`);\r\n    chatroomRef.push(chat(msg));\r\n  };\r\n\r\n  return (\r\n    <ChatStateContext.Provider\r\n      value={{\r\n        userList: userList,\r\n        chatroomList: chatroomList,\r\n        getUserProfile: getUserProfile,\r\n        getPrivateChat: getPrivateChat,\r\n        listenToPrivateChat: listenToPrivateChat,\r\n        sendPrivateMsg: sendPrivateMsg,\r\n        getChatroom: getChatroom,\r\n        listenToChatroom: listenToChatroom,\r\n        listenToUserInChatroom: listenToUserInChatroom,\r\n        sendMsg: sendMsg\r\n      }}\r\n    >\r\n      {children}\r\n    </ChatStateContext.Provider>\r\n  );\r\n}\r\n\r\nexport const useChatStateContext = () => useContext(ChatStateContext);"]},"metadata":{},"sourceType":"module"}